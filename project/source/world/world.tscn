[gd_scene load_steps=7 format=3 uid="uid://dc6up85jkv08n"]

[ext_resource type="MeshLibrary" uid="uid://oq8tioqnb03g" path="res://resource/mesh_lib/mesh_lib.tres" id="1_x28rg"]
[ext_resource type="Environment" uid="uid://b3dksqa4bdkqk" path="res://resource/skybox/world_environment.tres" id="2_bjs1r"]

[sub_resource type="GDScript" id="GDScript_ja8f1"]
script/source = "
extends Node3D

@onready var animation = $AnimationPlayer

func _ready():
	animation.play(\"animation\")
"

[sub_resource type="GDScript" id="GDScript_l5mj3"]
script/source = "
extends GridMap

@onready var object_tiles = {
	\"plains_tree\":preload(\"res://source/world/plains_tree.tscn\"),
	\"coniferous_tree\":preload(\"res://source/world/coniferous_tree.tscn\"),
	\"jungle_tree\":preload(\"res://source/world/jungle_tree.tscn\"),
	}

@onready var player = get_parent().get_parent().get_node(\"Player\")

var moisture = FastNoiseLite.new()      # 湿度
var temperature = FastNoiseLite.new()   # 温度
var altitude = FastNoiseLite.new()      # 海拔

var chunk_width = 16    # 单区块宽
var chunk_height = 16   # 单区块高

var chunk_x_num = 6   # 区块X轴渲染数
var chunk_y_num = 6   # 区块Y轴渲染数

var generated_chunks = {}

var biome_list = {
	\"deep_ocean\":[], # 深海群系
	\"ocean\":[], # 海洋群系
	\"shoal\":[], # 浅滩群系
	
	\"beach\":[], # 沙滩群系
	
	\"jungle\":[63,64,65,73,74,75,83,84,85,93,94,95], # 热带雨林群系
	\"plains\":[43,44,45,53,54,55], # 平原群系
	\"coniferous\":[3,4,5,13,14,15,23,24,25,33,34,35], # 针叶林群系
	
	\"desert\":[], # 沙漠群系
	\"mushroom\":[], # 蘑菇群系
	\"mountain\":[], # 山脉群系
}

var biome_data = {
	\"deep_ocean\":{}, # 深海群系
	\"ocean\":{}, # 海洋群系
	\"shoal\":{}, # 浅滩群系
	
	\"beach\":{}, # 沙滩群系
	
	\"jungle\":{\"jungle_tree\":0.01}, # 热带雨林群系
	\"plains\":{\"plains_tree\":0.03}, # 平原群系
	\"coniferous\":{\"coniferous_tree\":0.03}, # 针叶林群系
	
	\"desert\":{}, # 沙漠群系
	\"mushroom\":{}, # 蘑菇群系
	\"mountain\":{}, # 山脉群系
}

func _ready():
	moisture.seed = randi()
	temperature.seed = randi()
	altitude.seed = randi()
	
	moisture.frequency = 0.001
	temperature.frequency = 0.001

func _physics_process(delta):
	generate_chunks_around_player(player.transform.origin)

# 渲染区块控制器
func generate_chunks_around_player(position):
	var tile_pos = local_to_map(position)
	var current_chunk = Vector2(int(tile_pos.x / chunk_width), int(tile_pos.z / chunk_height))
	
	for x in range(current_chunk.x - (chunk_x_num - 1), current_chunk.x + chunk_x_num):
		for y in range(current_chunk.y - (chunk_y_num - 1), current_chunk.y + chunk_y_num):
			if not generated_chunks.has(Vector2(x, y)):
				generate_chunk(Vector2(x, y))
				generated_chunks[Vector2(x, y)] = true

# 渲染区块
func generate_chunk(chunk_pos):
	var chunk_x = chunk_pos.x
	var chunk_y = chunk_pos.y
	
	for x in range(chunk_width):
		for y in range(chunk_height):
			var real_x = chunk_x * chunk_width + x
			var real_y = chunk_y * chunk_height + y
			
			var moisture_noise = moisture.get_noise_2d(real_x, real_y) * 100
			var temperature_noise = temperature.get_noise_2d(real_x, real_y) * 100
			var altitude_noise = altitude.get_noise_2d(real_x, real_y) * 100
			
			var select_x = round(temperature_noise + 50) / 10
			var select_y = round(moisture_noise + 50) / 10
			
			select_x = int(select_x)
			select_y = int(select_y)
			
			if select_x >= 10:
				select_x = 9
			if select_x <= 0:
				select_x = null
			if select_y >= 10:
				select_y = 9
			if select_y < 0:
				select_y = 0
				
			# 深海
			if -1000 < altitude_noise and altitude_noise <= -16:
				set_cell_item(Vector3(real_x,0,real_y),9)
			# 海洋
			elif -16 < altitude_noise and altitude_noise <= -12:
				set_cell_item(Vector3(real_x,0,real_y),8)
			# 浅滩
			elif -12 < altitude_noise and altitude_noise <= 0:
				set_cell_item(Vector3(real_x,0,real_y),7)
			# 海滩
			elif 0 < altitude_noise and altitude_noise <= 9:
				set_cell_item(Vector3(real_x,0,real_y),6)
			# 湿度温度地形
			else:
				if int(str(select_x)+str(select_y)) < 100:
					set_cell_item(Vector3(real_x,0,real_y),\\
					int(str(select_x)+str(select_y)))
				else:
					print(int(str(select_x)+str(select_y)))
					set_cell_item(Vector3(real_x,0,real_y),0)
				
			var land_tile_data = get_cell_item(Vector3(real_x, 0, real_y))
			
			for id in biome_list[\"jungle\"]:
				if land_tile_data == id :
					var tile_probability = randf()
					if tile_probability <= biome_data[\"jungle\"][\"jungle_tree\"]:
						var tree_instantiate = object_tiles[\"jungle_tree\"].instantiate()
						tree_instantiate.transform.origin = Vector3(real_x, 0, real_y)
						add_child(tree_instantiate)
			
			for id in biome_list[\"plains\"]:
				if land_tile_data == id :
					var tile_probability = randf()
					if tile_probability <= biome_data[\"plains\"][\"plains_tree\"]:
						var tree_instantiate = object_tiles[\"plains_tree\"].instantiate()
						tree_instantiate.transform.origin = Vector3(real_x, 0, real_y)
						tree_instantiate.rotation.y = randi_range(0,360)
						add_child(tree_instantiate)
						
			for id in biome_list[\"coniferous\"]:
				if land_tile_data == id :
					var tile_probability = randf()
					if tile_probability <= biome_data[\"coniferous\"][\"coniferous_tree\"]:
						var tree_instantiate = object_tiles[\"coniferous_tree\"].instantiate()
						tree_instantiate.transform.origin = Vector3(real_x, 0, real_y)
						add_child(tree_instantiate)
			
"

[sub_resource type="Animation" id="Animation_cym8i"]
resource_name = "animation"
length = 10.0
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("SunLight:rotation")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 5),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector3(-3.14159, 0, 0), Vector3(3.14159, 0, 0)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("SunLight:visible")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 5),
"transitions": PackedFloat32Array(1, 1),
"update": 1,
"values": [true, false]
}
tracks/2/type = "value"
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/path = NodePath("MoonLight:rotation")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/keys = {
"times": PackedFloat32Array(5, 10),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector3(-3.14159, 0, 0), Vector3(3.14159, 0, 0)]
}
tracks/3/type = "value"
tracks/3/imported = false
tracks/3/enabled = true
tracks/3/path = NodePath("MoonLight:visible")
tracks/3/interp = 1
tracks/3/loop_wrap = true
tracks/3/keys = {
"times": PackedFloat32Array(5, 10),
"transitions": PackedFloat32Array(1, 1),
"update": 1,
"values": [true, false]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_abj8g"]
_data = {
"animation": SubResource("Animation_cym8i")
}

[node name="World" type="Node3D"]
script = SubResource("GDScript_ja8f1")

[node name="GridMap" type="GridMap" parent="."]
mesh_library = ExtResource("1_x28rg")
cell_size = Vector3(1, 1, 1)
collision_layer = 9
collision_mask = 9
script = SubResource("GDScript_l5mj3")

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = ExtResource("2_bjs1r")

[node name="SunLight" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, -1, -8.74227e-08, 0, 8.74228e-08, -0.999999, 0, 0, 0)
light_color = Color(1, 0.603922, 0, 1)
light_energy = 2.0
shadow_enabled = true
shadow_bias = 0.0
shadow_normal_bias = 0.0
shadow_blur = 3.0

[node name="MoonLight" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, -1, 8.74228e-08, 0, -8.74228e-08, -1, 0, 0, 0)
light_color = Color(0.27451, 0.333333, 1, 1)
light_energy = 0.3

[node name="DirectionalLight" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 0, 0)
light_energy = 0.1

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
"": SubResource("AnimationLibrary_abj8g")
}
